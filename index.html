<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desportivo Arco de Baúlhe - Registo de Multas</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #4a6741 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1rem; }
        .tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #e9ecef; }
        .tab { flex: 1; padding: 15px 20px; background: none; border: none; cursor: pointer; font-size: 1rem; font-weight: 600; color: #6c757d; transition: all 0.3s ease; }
        .tab.active { background: white; color: #2c3e50; border-bottom: 3px solid #4a6741; }
        .tab-content { padding: 30px; display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #4a6741; }
        .btn { background: linear-gradient(135deg, #4a6741 0%, #2c3e50 100%); color: white; padding: 12px 30px; border: none; border-radius: 25px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease; margin: 5px; text-decoration: none; display: inline-block; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn-secondary { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); }
        .btn-info { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }
        .btn-small { padding: 5px 15px; font-size: 0.8rem; }
        .grid { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
        .grid-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
        .card { background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #4a6741; margin-bottom: 20px; }
        .card h3 { color: #2c3e50; margin-bottom: 15px; }
        .card-success { border-left-color: #28a745; }
        .card-info { border-left-color: #17a2b8; }
        .multa-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #dc3545; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .multa-item.paga { border-left-color: #28a745; opacity: 0.7; }
        .multa-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .multa-valor { font-weight: bold; font-size: 1.2rem; color: #dc3545; }
        .multa-valor.pago { color: #28a745; }
        .multa-data { color: #6c757d; font-size: 0.9rem; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
        .alert { padding: 15px; margin-bottom: 20px; border-radius: 8px; border-left: 4px solid #17a2b8; background-color: #d1ecf1; color: #0c5460; }
        .alert-success { border-left-color: #28a745; background-color: #d4edda; color: #155724; }
        .alert-warning { border-left-color: #ffc107; background-color: #fff3cd; color: #856404; }
        .empty-state { color: #6c757d; text-align: center; padding: 40px 20px; font-style: italic; }
        .filtros-avancados { background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .filtros-avancados h4 { color: #1565c0; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .resultados-info { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .resultados-resumo { display: flex; gap: 20px; flex-wrap: wrap; }
        .resumo-item { text-align: center; }
        .resumo-numero { font-size: 1.5rem; font-weight: bold; color: #2c3e50; }
        .resumo-label { font-size: 0.9rem; color: #6c757d; }
        .export-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            .tabs { flex-direction: column; }
            .container { margin: 10px; border-radius: 10px; }
            .header { padding: 20px; }
            .header h1 { font-size: 2rem; }
            .multa-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .resultados-info { flex-direction: column; align-items: stretch; }
            .resultados-resumo { justify-content: center; }
            .export-actions { justify-content: center; }
        }
        
        /* Animações para feedback */
        .loading { opacity: 0.6; pointer-events: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Estilos para destacar filtros ativos */
        .filtro-ativo { border-color: #4a6741 !important; box-shadow: 0 0 0 0.2rem rgba(74, 103, 65, 0.25); }
        
        /* Loading spinner */
        .spinner { border: 2px solid #f3f3f3; border-radius: 50%; border-top: 2px solid #4a6741; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-left: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
		
		/* Estilos para autenticação - adicionar após os estilos existentes */
		.login-container { max-width: 400px; margin: 10% auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
		.login-header { background: linear-gradient(135deg, #2c3e50 0%, #4a6741 100%); color: white; padding: 40px 30px; text-align: center; }
		.login-content { padding: 40px 30px; }
		.login-tabs { display: flex; margin-bottom: 30px; background: #f8f9fa; border-radius: 8px; overflow: hidden; }
		.login-tab { flex: 1; padding: 12px; text-align: center; background: none; border: none; cursor: pointer; font-weight: 600; color: #6c757d; transition: all 0.3s; }
		.login-tab.active { background: #4a6741; color: white; }
		.user-info { position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 25px; }
		.user-avatar { width: 32px; height: 32px; border-radius: 50%; background: white; color: #4a6741; display: flex; align-items: center; justify-content: center; font-weight: bold; }
		.logout-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 15px; border-radius: 15px; cursor: pointer; transition: background 0.3s; }
		.logout-btn:hover { background: rgba(255,255,255,0.3); }
		.app-hidden { display: none !important; }
    </style>
</head>
<body>
		<!-- Página de Login -->
<div id="loginPage" class="login-container">
    <div class="login-header">
        <h1>⚽ DAB</h1>
        <p>Sistema de Gestão de Multas</p>
    </div>
    <div class="login-content">
        <div class="login-tabs">
            <button class="login-tab active" onclick="mostrarLoginTab('login')">Entrar</button>
            <button class="login-tab" onclick="mostrarLoginTab('registo')">Registar</button>
        </div>
        
        <!-- Formulário Login -->
        <div id="loginForm">
            <form onsubmit="realizarLogin(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Entrar</button>
            </form>
        </div>
        
        <!-- Formulário Registo -->
        <div id="registoForm" style="display: none;">
            <form onsubmit="realizarRegisto(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="registoEmail" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="registoPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Confirmar Password</label>
                    <input type="password" id="registoPasswordConfirm" required>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Registar</button>
            </form>
        </div>
        
        <div id="authMessage" class="alert" style="display: none; margin-top: 20px;"></div>
    </div>
</div>
		<div class="container app-hidden" id="mainApp">
			<div class="header">
			<h1>⚽ Desportivo Arco de Baúlhe - Registo de Multas</h1>
			<p>Gestão de Multas da Época 2025/2026</p>
			<div class="user-info" id="userInfo" style="display: none;">
			<div class="user-avatar" id="userAvatar">U</div>
			<span id="userEmail">utilizador@email.com</span>
			<button class="logout-btn" onclick="logout()">Sair</button>
			</div>
		</div>
        <div class="tabs">
            <button class="tab active" onclick="mostrarTab('registar', this)">Registar Multa</button>
            <button class="tab" onclick="mostrarTab('atletas', this)">Gestão Atletas</button>
            <button class="tab" onclick="mostrarTab('regras', this)">Regras de Multa</button>
            <button class="tab" onclick="mostrarTab('consultar', this)">Consultar Multas</button>
        </div>
        
        <!-- Tab: Registar Multa -->
        <div id="registar" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalMultas">0</div>
                    <div>Total de Multas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalValor">0€</div>
                    <div>Valor Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="valorPendente">0€</div>
                    <div>Por Pagar</div>
                </div>
            </div>
            <div class="card">
                <h3>Nova Multa</h3>
                <div id="alertaRegistar" class="alert" style="display: none;">
                    Para registar multas, primeiro adicione atletas e regras de multa nos outros separadores.
                </div>
                <form id="formMulta" onsubmit="registarMulta(event)">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>Atleta *</label>
                            <select id="atletaSelect" required>
                                <option value="">Selecionar atleta...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Regra Infringida *</label>
                            <select id="regraSelect" required>
                                <option value="">Selecionar regra...</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Data da Infração *</label>
                        <input type="date" id="dataMulta" required>
                    </div>
                    <div class="form-group">
                        <label>Observações (opcional)</label>
                        <textarea id="observacoes" rows="3" placeholder="Detalhes adicionais sobre a multa..."></textarea>
                    </div>
                    <button type="submit" class="btn">Registar Multa</button>
                </form>
            </div>
        </div>
        
        <!-- Tab: Gestão Atletas -->
        <div id="atletas" class="tab-content">
            <div class="card">
                <h3>Adicionar Atleta</h3>
                <form id="formAtleta" onsubmit="adicionarAtleta(event)">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>Nome *</label>
                            <input type="text" id="nomeAtleta" required placeholder="Nome completo do atleta">
                        </div>
                        <div class="form-group">
                            <label>Número da Camisola</label>
                            <input type="number" id="numeroAtleta" min="1" max="99" placeholder="Ex: 10">
                        </div>
                    </div>
                    <button type="submit" class="btn">Adicionar Atleta</button>
                </form>
            </div>
            <div class="card">
                <h3>Atletas Registados (<span id="contadorAtletas">0</span>)</h3>
                <div id="listaAtletas">
                    <div class="empty-state">Nenhum atleta registado ainda.</div>
                </div>
            </div>
        </div>
        
        <!-- Tab: Regras de Multa -->
        <div id="regras" class="tab-content">
            <div class="card">
                <h3>Nova Regra de Multa</h3>
                <form id="formRegra" onsubmit="adicionarRegra(event)">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>Descrição da Regra *</label>
                            <input type="text" id="descricaoRegra" required placeholder="Ex: Atraso ao treino">
                        </div>
                        <div class="form-group">
                            <label>Valor da Multa (€) *</label>
                            <input type="number" id="valorRegra" min="0" step="0.50" required placeholder="Ex: 5.00">
                        </div>
                    </div>
                    <button type="submit" class="btn">Adicionar Regra</button>
                </form>
            </div>
            <div class="card">
                <h3>Regras Ativas (<span id="contadorRegras">0</span>)</h3>
                <div id="listaRegras">
                    <div class="empty-state">Nenhuma regra de multa definida ainda.</div>
                </div>
            </div>
        </div>
        
        <!-- Tab: Consultar Multas -->
        <div id="consultar" class="tab-content">
            <!-- Filtros Avançados -->
            <div class="filtros-avancados">
                <h4>🔍 Filtros Avançados</h4>
                <div class="grid grid-4">
                    <div class="form-group">
                        <label>Atleta</label>
                        <select id="filtroAtleta" onchange="aplicarFiltros()">
                            <option value="">Todos os atletas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Estado</label>
                        <select id="filtroEstado" onchange="aplicarFiltros()">
                            <option value="">Todas as multas</option>
                            <option value="pendente">Pendentes</option>
                            <option value="paga">Pagas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data Início</label>
                        <input type="date" id="filtroDataInicio" onchange="aplicarFiltros()">
                    </div>
                    <div class="form-group">
                        <label>Data Fim</label>
                        <input type="date" id="filtroDataFim" onchange="aplicarFiltros()">
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="aplicarFiltros()" class="btn btn-info">Aplicar Filtros</button>
                    <button onclick="limparFiltros()" class="btn btn-secondary">Limpar Filtros</button>
                    <button onclick="definirPeriodoRapido('mes')" class="btn btn-secondary">Último Mês</button>
                    <button onclick="definirPeriodoRapido('trimestre')" class="btn btn-secondary">Último Trimestre</button>
                </div>
            </div>
            
            <!-- Resumo dos Resultados -->
            <div class="resultados-info">
                <div class="resultados-resumo">
                    <div class="resumo-item">
                        <div class="resumo-numero" id="resumoTotal">0</div>
                        <div class="resumo-label">Total Multas</div>
                    </div>
                    <div class="resumo-item">
                        <div class="resumo-numero" id="resumoValor">0€</div>
                        <div class="resumo-label">Valor Total</div>
                    </div>
                    <div class="resumo-item">
                        <div class="resumo-numero" id="resumoPendente">0€</div>
                        <div class="resumo-label">Por Pagar</div>
                    </div>
                    <div class="resumo-item">
                        <div class="resumo-numero" id="resumoPago">0€</div>
                        <div class="resumo-label">Já Pago</div>
                    </div>
                </div>
                <div class="export-actions">
                    <button onclick="exportarExcel()" class="btn btn-success" id="btnExportar">
                        📊 Exportar Excel
                    </button>
                    <button onclick="imprimirRelatorio()" class="btn btn-info">
                        🖨️ Imprimir
                    </button>
                </div>
            </div>
            
            <!-- Lista de Multas -->
            <div class="card">
                <h3>Lista de Multas (<span id="contadorMultas">0</span>)</h3>
                <div id="listaMultas">
                    <div class="empty-state">Nenhuma multa registada ainda.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase + App Logic -->
	<!-- SheetJS: exportar para .xlsx -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, updateDoc, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
		import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

        // Configuração Firebase (usa a tua configuração real)
        const firebaseConfig = {
            apiKey: "AIzaSyAmS6-cKRx_p6IStvwM2XZD7mHAmprSpc0",
            authDomain: "multasdab.firebaseapp.com",
            projectId: "multasdab",
            storageBucket: "multasdab.firebasestorage.app",
            messagingSenderId: "877647284675",
            appId: "1:877647284675:web:b274aa5f56c44071e8d576"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
		const auth = getAuth(app);
		let utilizadorAtual = null;

        // Estado da App
        let atletas = [];
        let regrasMulta = [];
        let multas = [];
        let multasFiltradas = [];

        // Referências das coleções
        const colAtletas = collection(db, 'atletas');
        const colRegras = collection(db, 'regras');
        const colMultas = collection(db, 'multas');
		
		// === AUTENTICAÇÃO ===
			window.mostrarLoginTab = function(tab) {
				document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
				if (tab === 'login') {
					document.querySelector('.login-tab').classList.add('active');
					document.getElementById('loginForm').style.display = 'block';
					document.getElementById('registoForm').style.display = 'none';
				} else {
					document.querySelectorAll('.login-tab')[1].classList.add('active');
					document.getElementById('loginForm').style.display = 'none';
					document.getElementById('registoForm').style.display = 'block';
				}
			}

			window.realizarLogin = async function(event) {
				event.preventDefault();
				const email = document.getElementById('loginEmail').value;
				const password = document.getElementById('loginPassword').value;
				
				try {
					await signInWithEmailAndPassword(auth, email, password);
					mostrarMensagemAuth('Login realizado com sucesso!', 'success');
				} catch (error) {
					mostrarMensagemAuth('Erro: ' + error.message, 'error');
				}
			}

			window.realizarRegisto = async function(event) {
				event.preventDefault();
				const email = document.getElementById('registoEmail').value;
				const password = document.getElementById('registoPassword').value;
				const confirmPassword = document.getElementById('registoPasswordConfirm').value;
    
				if (password !== confirmPassword) {
					mostrarMensagemAuth('As passwords não coincidem!', 'error');
					return;
				}
				
			// Função de logout
			window.logout = async function() {
				if (confirm('Tem certeza que deseja sair?')) {
				try {
				await signOut(auth);
					alert('Logout realizado com sucesso!');
					} catch (error) {
			console.error('Erro ao fazer logout:', error);
			alert('Erro ao fazer logout: ' + error.message);
		}
	}
};
    
			try {
        // Criar utilizador
				const userCredential = await createUserWithEmailAndPassword(auth, email, password);
				const user = userCredential.user;
        
        // Adicionar utilizador à coleção com status pendente
				await addDoc(collection(db, 'utilizadores'), {
				uid: user.uid,
				email: user.email,
				status: 'pendente',
				dataCriacao: new Date().toISOString(),
				tipo: 'pendente'
				});
        
        // Fazer logout imediatamente após registo
				await signOut(auth);
        
        // Mostrar mensagem de sucesso
        mostrarMensagemAuth('Registo efetuado com sucesso! A sua conta está pendente de aprovação pelo administrador. Será notificado quando puder aceder.', 'success');
        
        // Limpar formulário
        document.getElementById('registoForm').reset();
        
        // Voltar ao tab de login após 4 segundos
        setTimeout(() => {
            mostrarLoginTab('login');
        }, 4000);
        
    } catch (error) {
        let mensagemErro = 'Erro no registo: ';
        if (error.code === 'auth/email-already-in-use') {
            mensagemErro = 'Este email já está registado!';
        } else if (error.code === 'auth/weak-password') {
            mensagemErro = 'A password deve ter pelo menos 6 caracteres!';
        } else {
            mensagemErro += error.message;
        }
        mostrarMensagemAuth(mensagemErro, 'error');
    }
}

			function mostrarMensagemAuth(mensagem, tipo) {
				const msgElement = document.getElementById('authMessage');
				msgElement.textContent = mensagem;
				msgElement.className = tipo === 'success' ? 'alert alert-success' : 'alert';
				msgElement.style.display = 'block';
				setTimeout(() => msgElement.style.display = 'none', 3000);
			}

			// Listener do estado de autenticação
onAuthStateChanged(auth, async (user) => {
    if (user) {
        // Verificar se o utilizador está aprovado
        const utilizadoresSnapshot = await getDocs(
            query(collection(db, 'utilizadores'), where('uid', '==', user.uid))
        );
        
        if (utilizadoresSnapshot.empty) {
            // Utilizador não tem registo (conta antiga ou problema)
            await signOut(auth);
            mostrarMensagemAuth('Conta não autorizada. Entre em contacto com o administrador.', 'error');
            return;
        }
        
        const dadosUtilizador = utilizadoresSnapshot.docs[0].data();
        
        if (dadosUtilizador.status === 'pendente') {
            // Conta ainda não aprovada
            await signOut(auth);
            mostrarMensagemAuth('A sua conta ainda está pendente de aprovação. Por favor aguarde a aprovação do administrador.', 'error');
            return;
        }
        
        if (dadosUtilizador.status === 'rejeitado') {
            // Conta rejeitada
            await signOut(auth);
            mostrarMensagemAuth('A sua conta foi rejeitada. Entre em contacto com o administrador.', 'error');
            return;
        }
        
        // Utilizador aprovado - permitir acesso
        utilizadorAtual = { ...user, ...dadosUtilizador };
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainApp').classList.remove('app-hidden');
        document.getElementById('userInfo').style.display = 'flex';
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
        inicializar();
    } else {
        utilizadorAtual = null;
        document.getElementById('loginPage').style.display = 'block';
        document.getElementById('mainApp').classList.add('app-hidden');
        document.getElementById('userInfo').style.display = 'none';
    }
});

		// === FIM AUTENTICAÇÃO ===

        // Inicialização
        function inicializar() {
            const hoje = new Date();
            const elData = document.getElementById('dataMulta');
            if (elData) elData.value = hoje.toISOString().split('T')[0];

            // Escutar alterações em tempo real
            onSnapshot(colAtletas, (snapshot) => {
                atletas = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                atualizarInterface();
            });

            onSnapshot(colRegras, (snapshot) => {
                regrasMulta = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                atualizarInterface();
            });

            onSnapshot(colMultas, (snapshot) => {
                multas = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                atualizarInterface();
                if (document.getElementById('consultar').classList.contains('active')) {
                    aplicarFiltros();
                }
            });
        }

        // Navegação Tabs
        window.mostrarTab = function(nomeTab, elBotao) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            if (elBotao) elBotao.classList.add('active');
            document.getElementById(nomeTab).classList.add('active');
            
            if (nomeTab === 'consultar') {
                atualizarFiltros();
                aplicarFiltros();
            } else if (nomeTab === 'registar') {
                verificarRequisitos();
                atualizarEstatisticas();
            }
        }

        // Validações e UI
        function verificarRequisitos() {
            const alerta = document.getElementById('alertaRegistar');
            const form = document.getElementById('formMulta');
            if (atletas.length === 0 || regrasMulta.length === 0) {
                alerta.style.display = 'block';
                form.style.opacity = '0.5';
                form.style.pointerEvents = 'none';
            } else {
                alerta.style.display = 'none';
                form.style.opacity = '1';
                form.style.pointerEvents = 'auto';
            }
        }

        // CRUD: Atletas
        window.adicionarAtleta = async function(event) {
            event.preventDefault();
            const nome = document.getElementById('nomeAtleta').value.trim();
            const numeroVal = document.getElementById('numeroAtleta').value;

            if (!nome) return alert('Por favor, insira o nome do atleta.');
            if (numeroVal && atletas.some(a => a.numero == Number(numeroVal))) {
                return alert('Já existe um atleta com esse número de camisola!');
            }

            try {
                await addDoc(colAtletas, {
                    nome: nome,
                    numero: numeroVal ? Number(numeroVal) : null
                });
                document.getElementById('formAtleta').reset();
                alert(`Atleta "${nome}" adicionado com sucesso!`);
            } catch (error) {
                console.error('Erro ao adicionar atleta:', error);
                alert('Erro ao adicionar atleta. Tenta novamente.');
            }
        }

        window.removerAtleta = async function(atletaId) {
            const multasAtleta = multas.filter(m => m.atletaId === atletaId);
            if (multasAtleta.length > 0) {
                if (!confirm(`Este atleta tem ${multasAtleta.length} multa(s). Remover o atleta irá remover também todas as suas multas. Continuar?`)) return;
                for (const m of multasAtleta) {
                    await deleteDoc(doc(db, 'multas', m.id));
                }
            }
            await deleteDoc(doc(db, 'atletas', atletaId));
            alert('Atleta removido com sucesso!');
        }

        // CRUD: Regras
        window.adicionarRegra = async function(event) {
            event.preventDefault();
            const descricao = document.getElementById('descricaoRegra').value.trim();
            const valor = parseFloat(document.getElementById('valorRegra').value);
            if (!descricao) return alert('Por favor, insira a descrição da regra.');
            if (isNaN(valor) || valor < 0) return alert('Por favor, insira um valor válido para a multa.');
            
            try {
                await addDoc(colRegras, { descricao, valor });
                document.getElementById('formRegra').reset();
                alert(`Regra "${descricao}" adicionada com sucesso!`);
            } catch (error) {
                console.error('Erro ao adicionar regra:', error);
                alert('Erro ao adicionar regra. Tenta novamente.');
            }
        }

        window.removerRegra = async function(regraId) {
            const multasRegra = multas.filter(m => m.regraId === regraId);
            if (multasRegra.length > 0) {
                return alert(`Não é possível remover esta regra porque existe(m) ${multasRegra.length} multa(s) registada(s) com ela.`);
            }
            if (confirm('Tem certeza que deseja remover esta regra de multa?')) {
                await deleteDoc(doc(db, 'regras', regraId));
                alert('Regra de multa removida com sucesso!');
            }
        }

        // CRUD: Multas
        window.registarMulta = async function(event) {
            event.preventDefault();
            const atletaId = document.getElementById('atletaSelect').value;
            const regraId = document.getElementById('regraSelect').value;
            const data = document.getElementById('dataMulta').value;
            const observacoes = document.getElementById('observacoes').value.trim();

            if (!atletaId || !regraId || !data) return alert('Por favor, preencha todos os campos obrigatórios.');

            try {
                await addDoc(colMultas, {
                    atletaId,
                    regraId,
                    data,
                    observacoes,
                    paga: false,
                    dataPagamento: null
                });

                document.getElementById('atletaSelect').value = '';
                document.getElementById('regraSelect').value = '';
                document.getElementById('observacoes').value = '';

                const atleta = atletas.find(a => a.id === atletaId);
                const regra = regrasMulta.find(r => r.id === regraId);
                alert(`Multa registada com sucesso!\n\nAtleta: ${atleta?.nome}\nRegra: ${regra?.descricao}\nValor: ${regra ? regra.valor.toFixed(2) : '—'}€`);
            } catch (error) {
                console.error('Erro ao registar multa:', error);
                alert('Erro ao registar multa. Tenta novamente.');
            }
        }

        window.marcarComoPaga = async function(multaId) {
            const hoje = new Date().toISOString().split('T')[0];
            await updateDoc(doc(db, 'multas', multaId), { paga: true, dataPagamento: hoje });
            alert('Multa marcada como paga!');
        }

        window.marcarComoPendente = async function(multaId) {
            await updateDoc(doc(db, 'multas', multaId), { paga: false, dataPagamento: null });
            alert('Multa marcada como pendente!');
        }

        window.removerMulta = async function(multaId) {
            if (confirm('Tem certeza que deseja remover esta multa?')) {
                await deleteDoc(doc(db, 'multas', multaId));
                alert('Multa removida com sucesso!');
            }
        }

        // === NOVAS FUNCIONALIDADES DA FASE 1 ===

        // Filtros Avançados
        window.aplicarFiltros = function() {
            let filtradas = [...multas];

            // Filtro por atleta
            const filtroAtleta = document.getElementById('filtroAtleta').value;
            if (filtroAtleta) {
                filtradas = filtradas.filter(m => m.atletaId === filtroAtleta);
            }

            // Filtro por estado
            const filtroEstado = document.getElementById('filtroEstado').value;
            if (filtroEstado) {
                filtradas = filtradas.filter(m => filtroEstado === 'paga' ? m.paga : !m.paga);
            }

            // Filtro por data início
            const dataInicio = document.getElementById('filtroDataInicio').value;
            if (dataInicio) {
                filtradas = filtradas.filter(m => m.data >= dataInicio);
                document.getElementById('filtroDataInicio').classList.add('filtro-ativo');
            } else {
                document.getElementById('filtroDataInicio').classList.remove('filtro-ativo');
            }

            // Filtro por data fim
            const dataFim = document.getElementById('filtroDataFim').value;
            if (dataFim) {
                filtradas = filtradas.filter(m => m.data <= dataFim);
                document.getElementById('filtroDataFim').classList.add('filtro-ativo');
            } else {
                document.getElementById('filtroDataFim').classList.remove('filtro-ativo');
            }

            // Ordenar por data (mais recente primeiro)
            filtradas.sort((a, b) => new Date(b.data) - new Date(a.data));

            multasFiltradas = filtradas;
            mostrarMultas();
            atualizarResumoFiltros();
        }

        window.limparFiltros = function() {
            document.getElementById('filtroAtleta').value = '';
            document.getElementById('filtroEstado').value = '';
            document.getElementById('filtroDataInicio').value = '';
            document.getElementById('filtroDataFim').value = '';
            
            // Remover classes de filtro ativo
            document.getElementById('filtroDataInicio').classList.remove('filtro-ativo');
            document.getElementById('filtroDataFim').classList.remove('filtro-ativo');
            
            aplicarFiltros();
        }

        // Períodos Rápidos
        window.definirPeriodoRapido = function(tipo) {
            const hoje = new Date();
            let dataInicio = new Date();
            
            switch(tipo) {
                case 'mes':
                    dataInicio.setMonth(hoje.getMonth() - 1);
                    break;
                case 'trimestre':
                    dataInicio.setMonth(hoje.getMonth() - 3);
                    break;
            }
            
            document.getElementById('filtroDataInicio').value = dataInicio.toISOString().split('T')[0];
            document.getElementById('filtroDataFim').value = hoje.toISOString().split('T')[0];
            aplicarFiltros();
        }

        // Resumo dos Filtros
        function atualizarResumoFiltros() {
            const total = multasFiltradas.length;
            const valorTotal = multasFiltradas.reduce((sum, multa) => {
                const regra = regrasMulta.find(r => r.id === multa.regraId);
                return sum + (regra ? Number(regra.valor) : 0);
            }, 0);
            
            const valorPendente = multasFiltradas.filter(m => !m.paga).reduce((sum, multa) => {
                const regra = regrasMulta.find(r => r.id === multa.regraId);
                return sum + (regra ? Number(regra.valor) : 0);
            }, 0);
            
            const valorPago = valorTotal - valorPendente;
            
            document.getElementById('resumoTotal').textContent = total;
            document.getElementById('resumoValor').textContent = valorTotal.toFixed(2) + '€';
            document.getElementById('resumoPendente').textContent = valorPendente.toFixed(2) + '€';
            document.getElementById('resumoPago').textContent = valorPago.toFixed(2) + '€';
        }

        // Exportação Excel
        window.exportarExcel = function() {
            if (multasFiltradas.length === 0) {
                alert('Não há multas para exportar com os filtros aplicados.');
                return;
            }

            const btnExportar = document.getElementById('btnExportar');
            btnExportar.innerHTML = '📊 Exportando... <div class="spinner"></div>';
            btnExportar.disabled = true;

            // Preparar dados para Excel (cada coluna será uma célula separada)
			const dadosExcel = [];

			// Cabeçalho
			dadosExcel.push([
				'Nº Atleta',
				'Nome do Atleta',
				'Regra Infringida',
				'Valor (€)',
				'Data da Infração',
				'Estado',
				'Data Pagamento',
				'Observações'
			]);

			// Dados das multas
			multasFiltradas.forEach(multa => {
				const atleta = atletas.find(a => a.id === multa.atletaId);
				const regra = regrasMulta.find(r => r.id === multa.regraId);

				if (atleta && regra) {
					dadosExcel.push([
						atleta.numero || '-',
						atleta.nome,
						regra.descricao,
						Number(regra.valor), // <-- número, não string
						new Date(multa.data).toLocaleDateString('pt-PT'),
						multa.paga ? 'Paga' : 'Pendente',
						multa.dataPagamento ? new Date(multa.dataPagamento).toLocaleDateString('pt-PT') : '-',
						multa.observacoes || '-'
					]);
				}
			});

            // Criar e baixar Excel (versão robusta com tratamento de erros)
			try {
				criarExcel(dadosExcel);
				btnExportar.innerHTML = '📊 Exportar Excel';
				btnExportar.disabled = false;
				alert('📊 Exportação concluída!\n\nO ficheiro foi gerado em .xlsx (compatível com Excel).');
			} catch (err) {
				console.error('Erro ao exportar para Excel:', err);
				btnExportar.innerHTML = '📊 Exportar Excel';
				btnExportar.disabled = false;
				alert('Erro ao exportar ficheiro. Verifica o console do browser para mais detalhes.');
			}

        }

			function criarExcel(dados) {
			// Ajusta larguras das colunas automaticamente com base no conteúdo
				function calcularLarguras(aoa) {
					const nCols = aoa[0] ? aoa[0].length : 0;
					const colWidths = new Array(nCols).fill(0).map(() => ({ wch: 10 }));
					for (let r = 0; r < aoa.length; r++) {
						for (let c = 0; c < nCols; c++) {
						const cell = aoa[r][c];
						const comprimento = String(cell === null || cell === undefined ? '' : cell).length;
						if (comprimento > (colWidths[c].wch || 10)) colWidths[c].wch = Math.min(comprimento + 2, 50);
					}
				}
				return colWidths;
		}

			// Cria worksheet a partir do array de arrays
			const ws = XLSX.utils.aoa_to_sheet(dados);

			// Ajustar larguras
			ws['!cols'] = calcularLarguras(dados);

			// Workbook
			const wb = XLSX.utils.book_new();
			XLSX.utils.book_append_sheet(wb, ws, "Multas");

			// Gerar e baixar ficheiro .xlsx
			const agora = new Date();
			const dataStr = agora.toISOString().split('T')[0];
			XLSX.writeFile(wb, `multas_DAB_${dataStr}.xlsx`);
		}

        // Imprimir Relatório
        window.imprimirRelatorio = function() {
            if (multasFiltradas.length === 0) {
                alert('Não há multas para imprimir com os filtros aplicados.');
                return;
            }

            // Criar janela de impressão
            const janelaImpressao = window.open('', '_blank');
            
            let html = `
                <html>
                <head>
                    <title>Relatório de Multas - Desportivo Arco de Baúlhe</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .cabecalho { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
                        .resumo { background: #f5f5f5; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
                        .resumo-item { display: inline-block; margin-right: 30px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
                        th { background-color: #4a6741; color: white; }
                        .pendente { background-color: #ffebee; }
                        .paga { background-color: #e8f5e8; }
                        .rodape { margin-top: 30px; text-align: center; font-size: 10px; color: #666; }
                        @media print {
                            body { margin: 10px; }
                            .cabecalho { page-break-after: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="cabecalho">
                        <h1>⚽ Desportivo Arco de Baúlhe</h1>
                        <h2>Relatório de Multas</h2>
                        <p>Data de Emissão: ${new Date().toLocaleDateString('pt-PT')}</p>
                    </div>
                    
                    <div class="resumo">
                        <div class="resumo-item"><strong>Total de Multas:</strong> ${multasFiltradas.length}</div>
                        <div class="resumo-item"><strong>Valor Total:</strong> ${multasFiltradas.reduce((sum, m) => {
                            const regra = regrasMulta.find(r => r.id === m.regraId);
                            return sum + (regra ? Number(regra.valor) : 0);
                        }, 0).toFixed(2)}€</div>
                        <div class="resumo-item"><strong>Por Pagar:</strong> ${multasFiltradas.filter(m => !m.paga).reduce((sum, m) => {
                            const regra = regrasMulta.find(r => r.id === m.regraId);
                            return sum + (regra ? Number(regra.valor) : 0);
                        }, 0).toFixed(2)}€</div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Nº</th>
                                <th>Atleta</th>
                                <th>Regra</th>
                                <th>Valor</th>
                                <th>Data</th>
                                <th>Estado</th>
                                <th>Observações</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            multasFiltradas.forEach(multa => {
                const atleta = atletas.find(a => a.id === multa.atletaId);
                const regra = regrasMulta.find(r => r.id === multa.regraId);
                
                if (atleta && regra) {
                    html += `
                        <tr class="${multa.paga ? 'paga' : 'pendente'}">
                            <td>${atleta.numero || '-'}</td>
                            <td>${atleta.nome}</td>
                            <td>${regra.descricao}</td>
                            <td>${regra.valor.toFixed(2)}€</td>
                            <td>${new Date(multa.data).toLocaleDateString('pt-PT')}</td>
                            <td>${multa.paga ? '✅ Paga' : '❌ Pendente'}</td>
                            <td>${multa.observacoes || '-'}</td>
                        </tr>
                    `;
                }
            });

            html += `
                        </tbody>
                    </table>
                    
                    <div class="rodape">
                        <p>Este relatório foi gerado automaticamente pelo Sistema de Gestão de Multas do Desportivo Arco de Baúlhe</p>
                    </div>
                </body>
                </html>
            `;

            janelaImpressao.document.write(html);
            janelaImpressao.document.close();
            
            // Aguardar carregamento e imprimir
            setTimeout(() => {
                janelaImpressao.print();
            }, 500);
        }

        // Atualizar UI
        function atualizarInterface() {
            atualizarSelectAtletas();
            atualizarSelectRegras();
            mostrarAtletas();
            mostrarRegras();
            atualizarEstatisticas();
            verificarRequisitos();
        }

        function atualizarSelectAtletas() {
            const selects = ['atletaSelect', 'filtroAtleta'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                const valorAtual = select.value;
                while (select.children.length > 1) select.removeChild(select.lastChild);
                
                // Ordenar atletas por nome
                const atletasOrdenados = [...atletas].sort((a, b) => a.nome.localeCompare(b.nome));
                
                atletasOrdenados.forEach(atleta => {
                    const option = document.createElement('option');
                    option.value = atleta.id;
                    option.textContent = `${atleta.nome}${atleta.numero ? ' (#' + atleta.numero + ')' : ''}`;
                    select.appendChild(option);
                });
                select.value = valorAtual;
            });
        }

        function atualizarSelectRegras() {
            const select = document.getElementById('regraSelect');
            if (!select) return;
            const valorAtual = select.value;
            while (select.children.length > 1) select.removeChild(select.lastChild);
            
            // Ordenar regras por valor
            const regrasOrdenadas = [...regrasMulta].sort((a, b) => a.valor - b.valor);
            
            regrasOrdenadas.forEach(regra => {
                const option = document.createElement('option');
                option.value = regra.id;
                option.textContent = `${regra.descricao} - ${regra.valor.toFixed(2)}€`;
                select.appendChild(option);
            });
            select.value = valorAtual;
        }

        function mostrarAtletas() {
            const container = document.getElementById('listaAtletas');
            const contador = document.getElementById('contadorAtletas');
            contador.textContent = atletas.length;
            
            if (atletas.length === 0) {
                container.innerHTML = '<div class="empty-state">Nenhum atleta registado ainda.</div>';
                return;
            }
            
            let html = '';
            atletas.forEach(atleta => {
                const multasAtleta = multas.filter(m => m.atletaId === atleta.id);
                const valorTotal = multasAtleta.reduce((total, multa) => {
                    const regra = regrasMulta.find(r => r.id === multa.regraId);
                    return total + (regra ? Number(regra.valor) : 0);
                }, 0);
                const valorPendente = multasAtleta.filter(m => !m.paga).reduce((total, multa) => {
                    const regra = regrasMulta.find(r => r.id === multa.regraId);
                    return total + (regra ? Number(regra.valor) : 0);
                }, 0);
                
                html += `
                    <div class="multa-item">
                        <div class="multa-header">
                            <strong>${atleta.nome}${atleta.numero ? ' (#' + atleta.numero + ')' : ''}</strong>
                            <div>
                                <span class="multa-valor">${valorPendente.toFixed(2)}€ pendente</span>
                                <button onclick="removerAtleta('${atleta.id}')" class="btn btn-danger btn-small">Remover</button>
                            </div>
                        </div>
                        <div style="color: #6c757d; font-size: 0.9rem;">Total de multas: ${multasAtleta.length} | Valor total: ${valorTotal.toFixed(2)}€</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function mostrarRegras() {
            const container = document.getElementById('listaRegras');
            const contador = document.getElementById('contadorRegras');
            contador.textContent = regrasMulta.length;
            
            if (regrasMulta.length === 0) {
                container.innerHTML = '<div class="empty-state">Nenhuma regra de multa definida ainda.</div>';
                return;
            }
            
            let html = '';
            regrasMulta.forEach(regra => {
                const vezesUsada = multas.filter(m => m.regraId === regra.id).length;
                
                html += `
                    <div class="multa-item">
                        <div class="multa-header">
                            <strong>${regra.descricao}</strong>
                            <div>
                                <span class="multa-valor">${Number(regra.valor).toFixed(2)}€</span>
                                <button onclick="removerRegra('${regra.id}')" class="btn btn-danger btn-small">Remover</button>
                            </div>
                        </div>
                        <div style="color: #6c757d; font-size: 0.9rem;">Usada ${vezesUsada} vez${vezesUsada !== 1 ? 'es' : ''}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function atualizarEstatisticas() {
            const totalMultas = multas.length;
            const valorTotal = multas.reduce((total, multa) => {
                const regra = regrasMulta.find(r => r.id === multa.regraId);
                return total + (regra ? Number(regra.valor) : 0);
            }, 0);
            const valorPendente = multas.filter(m => !m.paga).reduce((total, multa) => {
                const regra = regrasMulta.find(r => r.id === multa.regraId);
                return total + (regra ? Number(regra.valor) : 0);
            }, 0);
            
            document.getElementById('totalMultas').textContent = totalMultas;
            document.getElementById('totalValor').textContent = valorTotal.toFixed(2) + '€';
            document.getElementById('valorPendente').textContent = valorPendente.toFixed(2) + '€';
        }

        function atualizarFiltros() { 
            atualizarSelectAtletas(); 
        }

        function mostrarMultas() {
            const container = document.getElementById('listaMultas');
            const contador = document.getElementById('contadorMultas');
            
            contador.textContent = multasFiltradas.length;
            
            if (multasFiltradas.length === 0) {
                container.innerHTML = '<div class="empty-state">Nenhuma multa encontrada com os filtros aplicados.</div>';
                return;
            }
            
            let html = '';
            multasFiltradas.forEach(multa => {
                const atleta = atletas.find(a => a.id === multa.atletaId);
                const regra = regrasMulta.find(r => r.id === multa.regraId);
                
                if (!atleta || !regra) return;
                
                html += `
                    <div class="multa-item ${multa.paga ? 'paga' : ''} fade-in">
                        <div class="multa-header">
                            <div>
                                <strong>${atleta.nome}${atleta.numero ? ' (#' + atleta.numero + ')' : ''}</strong>
                                <div style="font-size: 0.9rem; color: #6c757d;">${regra.descricao}</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="multa-valor ${multa.paga ? 'pago' : ''}">${Number(regra.valor).toFixed(2)}€</div>
                                <div class="multa-data">${new Date(multa.data).toLocaleDateString('pt-PT')}</div>
                            </div>
                        </div>
                        ${multa.observacoes ? `<div style="font-style: italic; color: #6c757d; margin-top: 5px;">${multa.observacoes}</div>` : ''}
                        <div style="margin-top: 10px;">
                            ${multa.paga ?
                                `<span style=\"color: #28a745; font-weight: bold;\">✅ Paga em ${multa.dataPagamento ? new Date(multa.dataPagamento).toLocaleDateString('pt-PT') : ''}</span>
                                 <button onclick=\"marcarComoPendente('${multa.id}')\" class=\"btn btn-secondary btn-small\">Marcar como Pendente</button>` :
                                `<button onclick=\"marcarComoPaga('${multa.id}')\" class=\"btn btn-small\">Marcar como Paga</button>`}
                            <button onclick="removerMulta('${multa.id}')" class="btn btn-danger btn-small">Remover</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Debug Helpers
        window.debugApp = {
            atletas: () => atletas,
            regras: () => regrasMulta,
            multas: () => multas,
            multasFiltradas: () => multasFiltradas
        };

        // Inicializar
        window.addEventListener('DOMContentLoaded', inicializar);
    </script>
</body>
</html>