<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Multas - Equipa de Futebol</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #4a6741 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1rem; }
        .tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #e9ecef; }
        .tab { flex: 1; padding: 15px 20px; background: none; border: none; cursor: pointer; font-size: 1rem; font-weight: 600; color: #6c757d; transition: all 0.3s ease; }
        .tab.active { background: white; color: #2c3e50; border-bottom: 3px solid #4a6741; }
        .tab-content { padding: 30px; display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #4a6741; }
        .btn { background: linear-gradient(135deg, #4a6741 0%, #2c3e50 100%); color: white; padding: 12px 30px; border: none; border-radius: 25px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease; margin: 5px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn-secondary { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .btn-small { padding: 5px 15px; font-size: 0.8rem; }
        .grid { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .card { background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #4a6741; margin-bottom: 20px; }
        .card h3 { color: #2c3e50; margin-bottom: 15px; }
        .multa-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #dc3545; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .multa-item.paga { border-left-color: #28a745; opacity: 0.7; }
        .multa-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .multa-valor { font-weight: bold; font-size: 1.2rem; color: #dc3545; }
        .multa-valor.pago { color: #28a745; }
        .multa-data { color: #6c757d; font-size: 0.9rem; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
        .alert { padding: 15px; margin-bottom: 20px; border-radius: 8px; border-left: 4px solid #17a2b8; background-color: #d1ecf1; color: #0c5460; }
        .empty-state { color: #6c757d; text-align: center; padding: 40px 20px; font-style: italic; }
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
            .tabs { flex-direction: column; }
            .container { margin: 10px; border-radius: 10px; }
            .header { padding: 20px; }
            .header h1 { font-size: 2rem; }
            .multa-header { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚽ Sistema de Multas</h1>
            <p>Gestão de Multas da Equipa de Futebol</p>
        </div>
        <div class="tabs">
            <button class="tab active" onclick="mostrarTab('registar', this)">Registar Multa</button>
            <button class="tab" onclick="mostrarTab('atletas', this)">Gestão Atletas</button>
            <button class="tab" onclick="mostrarTab('regras', this)">Regras de Multa</button>
            <button class="tab" onclick="mostrarTab('consultar', this)">Consultar Multas</button>
        </div>
        <!-- Tab: Registar Multa -->
        <div id="registar" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalMultas">0</div>
                    <div>Total de Multas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalValor">0€</div>
                    <div>Valor Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="valorPendente">0€</div>
                    <div>Por Pagar</div>
                </div>
            </div>
            <div class="card">
                <h3>Nova Multa</h3>
                <div id="alertaRegistar" class="alert" style="display: none;">
                    Para registar multas, primeiro adicione atletas e regras de multa nos outros separadores.
                </div>
                <form id="formMulta" onsubmit="registarMulta(event)">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>Atleta *</label>
                            <select id="atletaSelect" required>
                                <option value="">Selecionar atleta...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Regra Infringida *</label>
                            <select id="regraSelect" required>
                                <option value="">Selecionar regra...</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Data da Infração *</label>
                        <input type="date" id="dataMulta" required>
                    </div>
                    <div class="form-group">
                        <label>Observações (opcional)</label>
                        <textarea id="observacoes" rows="3" placeholder="Detalhes adicionais sobre a multa..."></textarea>
                    </div>
                    <button type="submit" class="btn">Registar Multa</button>
                </form>
            </div>
        </div>
        <!-- Tab: Gestão Atletas -->
        <div id="atletas" class="tab-content">
            <div class="card">
                <h3>Adicionar Atleta</h3>
                <form id="formAtleta" onsubmit="adicionarAtleta(event)">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>Nome *</label>
                            <input type="text" id="nomeAtleta" required placeholder="Nome completo do atleta">
                        </div>
                        <div class="form-group">
                            <label>Número da Camisola</label>
                            <input type="number" id="numeroAtleta" min="1" max="99" placeholder="Ex: 10">
                        </div>
                    </div>
                    <button type="submit" class="btn">Adicionar Atleta</button>
                </form>
            </div>
            <div class="card">
                <h3>Atletas Registados (<span id="contadorAtletas">0</span>)</h3>
                <div id="listaAtletas">
                    <div class="empty-state">Nenhum atleta registado ainda.</div>
                </div>
            </div>
        </div>
        <!-- Tab: Regras de Multa -->
        <div id="regras" class="tab-content">
            <div class="card">
                <h3>Nova Regra de Multa</h3>
                <form id="formRegra" onsubmit="adicionarRegra(event)">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>Descrição da Regra *</label>
                            <input type="text" id="descricaoRegra" required placeholder="Ex: Atraso ao treino">
                        </div>
                        <div class="form-group">
                            <label>Valor da Multa (€) *</label>
                            <input type="number" id="valorRegra" min="0" step="0.50" required placeholder="Ex: 5.00">
                        </div>
                    </div>
                    <button type="submit" class="btn">Adicionar Regra</button>
                </form>
            </div>
            <div class="card">
                <h3>Regras Ativas (<span id="contadorRegras">0</span>)</h3>
                <div id="listaRegras">
                    <div class="empty-state">Nenhuma regra de multa definida ainda.</div>
                </div>
            </div>
        </div>
        <!-- Tab: Consultar Multas -->
        <div id="consultar" class="tab-content">
            <div class="card">
                <h3>Filtros</h3>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label>Atleta</label>
                        <select id="filtroAtleta">
                            <option value="">Todos os atletas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Estado</label>
                        <select id="filtroEstado">
                            <option value="">Todas as multas</option>
                            <option value="pendente">Pendentes</option>
                            <option value="paga">Pagas</option>
                        </select>
                    </div>
                </div>
                <button onclick="aplicarFiltros()" class="btn">Aplicar Filtros</button>
                <button onclick="limparFiltros()" class="btn btn-secondary">Limpar Filtros</button>
            </div>
            <div class="card">
                <h3>Lista de Multas (<span id="contadorMultas">0</span>)</h3>
                <div id="listaMultas">
                    <div class="empty-state">Nenhuma multa registada ainda.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase + App Logic (MÓDULO) -->
    <script type="module">
        // ====== Firebase SDKs ======
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, updateDoc, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // ====== Configuração do teu projeto Firebase ======
        const firebaseConfig = {
            apiKey: "AIzaSyAmS6-cKRx_p6IStvwM2XZD7mHAmprSpc0",
            authDomain: "multasdab.firebaseapp.com",
            projectId: "multasdab",
            storageBucket: "multasdab.firebasestorage.app",
            messagingSenderId: "877647284675",
            appId: "1:877647284675:web:b274aa5f56c44071e8d576"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ====== Estado da App (memória) ======
        let atletas = [];      // [{id, nome, numero}]
        let regrasMulta = [];  // [{id, descricao, valor}]
        let multas = [];       // [{id, atletaId, regraId, data, observacoes, paga, dataPagamento}]

        // ====== Referências das coleções ======
        const colAtletas = collection(db, 'atletas');
        const colRegras = collection(db, 'regras');
        const colMultas = collection(db, 'multas');

        // ====== Inicialização ======
        function inicializar() {
            // Definir data de hoje como padrão
            const hoje = new Date();
            const elData = document.getElementById('dataMulta');
            if (elData) elData.value = hoje.toISOString().split('T')[0];

            // Escutar alterações em tempo real
            onSnapshot(colAtletas, (snapshot) => {
                atletas = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                atualizarInterface();
            });

            onSnapshot(colRegras, (snapshot) => {
                regrasMulta = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                atualizarInterface();
            });

            onSnapshot(colMultas, (snapshot) => {
                multas = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                atualizarInterface();
                if (document.getElementById('consultar').classList.contains('active')) {
                    mostrarMultas();
                }
            });
        }

        // ====== Navegação Tabs ======
        window.mostrarTab = function(nomeTab, elBotao) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            if (elBotao) elBotao.classList.add('active');
            document.getElementById(nomeTab).classList.add('active');
            if (nomeTab === 'consultar') {
                atualizarFiltros();
                mostrarMultas();
            } else if (nomeTab === 'registar') {
                verificarRequisitos();
                atualizarEstatisticas();
            }
        }

        // ====== Validações e UI ======
        function verificarRequisitos() {
            const alerta = document.getElementById('alertaRegistar');
            const form = document.getElementById('formMulta');
            if (atletas.length === 0 || regrasMulta.length === 0) {
                alerta.style.display = 'block';
                form.style.opacity = '0.5';
                form.style.pointerEvents = 'none';
            } else {
                alerta.style.display = 'none';
                form.style.opacity = '1';
                form.style.pointerEvents = 'auto';
            }
        }

        // ====== CRUD: Atletas ======
        window.adicionarAtleta = async function(event) {
            event.preventDefault();
            const nome = document.getElementById('nomeAtleta').value.trim();
            const numeroVal = document.getElementById('numeroAtleta').value;

            if (!nome) return alert('Por favor, insira o nome do atleta.');
            if (numeroVal && atletas.some(a => a.numero == Number(numeroVal))) {
                return alert('Já existe um atleta com esse número de camisola!');
            }

            await addDoc(colAtletas, {
                nome: nome,
                numero: numeroVal ? Number(numeroVal) : null
            });

            document.getElementById('formAtleta').reset();
            alert(`Atleta "${nome}" adicionado com sucesso!`);
        }

        window.removerAtleta = async function(atletaId) {
            const multasAtleta = multas.filter(m => m.atletaId === atletaId);
            if (multasAtleta.length > 0) {
                if (!confirm(`Este atleta tem ${multasAtleta.length} multa(s). Remover o atleta irá remover também todas as suas multas. Continuar?`)) return;
                // Remover multas do atleta
                for (const m of multasAtleta) {
                    await deleteDoc(doc(db, 'multas', m.id));
                }
            }
            await deleteDoc(doc(db, 'atletas', atletaId));
            alert('Atleta removido com sucesso!');
        }

        // ====== CRUD: Regras ======
        window.adicionarRegra = async function(event) {
            event.preventDefault();
            const descricao = document.getElementById('descricaoRegra').value.trim();
            const valor = parseFloat(document.getElementById('valorRegra').value);
            if (!descricao) return alert('Por favor, insira a descrição da regra.');
            if (isNaN(valor) || valor < 0) return alert('Por favor, insira um valor válido para a multa.');
            await addDoc(colRegras, { descricao, valor });
            document.getElementById('formRegra').reset();
            alert(`Regra "${descricao}" adicionada com sucesso!`);
        }

        window.removerRegra = async function(regraId) {
            const multasRegra = multas.filter(m => m.regraId === regraId);
            if (multasRegra.length > 0) {
                return alert(`Não é possível remover esta regra porque existe(m) ${multasRegra.length} multa(s) registada(s) com ela.`);
            }
            if (confirm('Tem certeza que deseja remover esta regra de multa?')) {
                await deleteDoc(doc(db, 'regras', regraId));
                alert('Regra de multa removida com sucesso!');
            }
        }

        // ====== CRUD: Multas ======
        window.registarMulta = async function(event) {
            event.preventDefault();
            const atletaId = document.getElementById('atletaSelect').value; // string ID
            const regraId = document.getElementById('regraSelect').value;   // string ID
            const data = document.getElementById('dataMulta').value;
            const observacoes = document.getElementById('observacoes').value.trim();

            if (!atletaId || !regraId || !data) return alert('Por favor, preencha todos os campos obrigatórios.');

            await addDoc(colMultas, {
                atletaId,
                regraId,
                data,
                observacoes,
                paga: false,
                dataPagamento: null
            });

            document.getElementById('atletaSelect').value = '';
            document.getElementById('regraSelect').value = '';
            document.getElementById('observacoes').value = '';

            const atleta = atletas.find(a => a.id === atletaId);
            const regra = regrasMulta.find(r => r.id === regraId);
            alert(`Multa registada com sucesso!\n\nAtleta: ${atleta?.nome}\nRegra: ${regra?.descricao}\nValor: ${regra ? regra.valor.toFixed(2) : '—'}€`);
        }

        window.marcarComoPaga = async function(multaId) {
            const hoje = new Date().toISOString().split('T')[0];
            await updateDoc(doc(db, 'multas', multaId), { paga: true, dataPagamento: hoje });
            alert('Multa marcada como paga!');
        }

        window.marcarComoPendente = async function(multaId) {
            await updateDoc(doc(db, 'multas', multaId), { paga: false, dataPagamento: null });
            alert('Multa marcada como pendente!');
        }

        window.removerMulta = async function(multaId) {
            if (confirm('Tem certeza que deseja remover esta multa?')) {
                await deleteDoc(doc(db, 'multas', multaId));
                alert('Multa removida com sucesso!');
            }
        }

        // ====== Atualizar UI ======
        function atualizarInterface() {
            atualizarSelectAtletas();
            atualizarSelectRegras();
            mostrarAtletas();
            mostrarRegras();
            atualizarEstatisticas();
            verificarRequisitos();
        }

        function atualizarSelectAtletas() {
            const selects = ['atletaSelect', 'filtroAtleta'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                const valorAtual = select.value;
                while (select.children.length > 1) select.removeChild(select.lastChild);
                atletas.forEach(atleta => {
                    const option = document.createElement('option');
                    option.value = atleta.id; // ID Firestore
                    option.textContent = `${atleta.nome}${atleta.numero ? ' (#' + atleta.numero + ')' : ''}`;
                    select.appendChild(option);
                });
                select.value = valorAtual;
            });
        }

        function atualizarSelectRegras() {
            const select = document.getElementById('regraSelect');
            if (!select) return;
            const valorAtual = select.value;
            while (select.children.length > 1) select.removeChild(select.lastChild);
            regrasMulta.forEach(regra => {
                const option = document.createElement('option');
                option.value = regra.id; // ID Firestore
                option.textContent = `${regra.descricao} - ${regra.valor.toFixed(2)}€`;
                select.appendChild(option);
            });
            select.value = valorAtual;
        }

        function mostrarAtletas() {
            const container = document.getElementById('listaAtletas');
            const contador = document.getElementById('contadorAtletas');
            contador.textContent = atletas.length;
            if (atletas.length === 0) {
                container.innerHTML = '<div class="empty-state">Nenhum atleta registado ainda.</div>';
                return;
            }
            let html = '';
            atletas.forEach(atleta => {
                const multasAtleta = multas.filter(m => m.atletaId === atleta.id);
                const valorTotal = multasAtleta.reduce((total, multa) => {
                    const regra = regrasMulta.find(r => r.id === multa.regraId);
                    return total + (regra ? Number(regra.valor) : 0);
                }, 0);
                const valorPendente = multasAtleta.filter(m => !m.paga).reduce((total, multa) => {
                    const regra = regrasMulta.find(r => r.id === multa.regraId);
                    return total + (regra ? Number(regra.valor) : 0);
                }, 0);
                html += `
                    <div class="multa-item">
                        <div class="multa-header">
                            <strong>${atleta.nome}${atleta.numero ? ' (#' + atleta.numero + ')' : ''}</strong>
                            <div>
                                <span class="multa-valor">${valorPendente.toFixed(2)}€ pendente</span>
                                <button onclick="removerAtleta('${atleta.id}')" class="btn btn-danger btn-small">Remover</button>
                            </div>
                        </div>
                        <div style="color: #6c757d; font-size: 0.9rem;">Total de multas: ${multasAtleta.length} | Valor total: ${valorTotal.toFixed(2)}€</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function mostrarRegras() {
            const container = document.getElementById('listaRegras');
            const contador = document.getElementById('contadorRegras');
            contador.textContent = regrasMulta.length;
            if (regrasMulta.length === 0) {
                container.innerHTML = '<div class="empty-state">Nenhuma regra de multa definida ainda.</div>';
                return;
            }
            let html = '';
            regrasMulta.forEach(regra => {
                const vezesUsada = multas.filter(m => m.regraId === regra.id).length;
                html += `
                    <div class="multa-item">
                        <div class="multa-header">
                            <strong>${regra.descricao}</strong>
                            <div>
                                <span class="multa-valor">${Number(regra.valor).toFixed(2)}€</span>
                                <button onclick="removerRegra('${regra.id}')" class="btn btn-danger btn-small">Remover</button>
                            </div>
                        </div>
                        <div style="color: #6c757d; font-size: 0.9rem;">Usada ${vezesUsada} vez${vezesUsada !== 1 ? 'es' : ''}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function atualizarEstatisticas() {
            const totalMultas = multas.length;
            const valorTotal = multas.reduce((total, multa) => {
                const regra = regrasMulta.find(r => r.id === multa.regraId);
                return total + (regra ? Number(regra.valor) : 0);
            }, 0);
            const valorPendente = multas.filter(m => !m.paga).reduce((total, multa) => {
                const regra = regrasMulta.find(r => r.id === multa.regraId);
                return total + (regra ? Number(regra.valor) : 0);
            }, 0);
            document.getElementById('totalMultas').textContent = totalMultas;
            document.getElementById('totalValor').textContent = valorTotal.toFixed(2) + '€';
            document.getElementById('valorPendente').textContent = valorPendente.toFixed(2) + '€';
        }

        function atualizarFiltros() { atualizarSelectAtletas(); }

        function mostrarMultas() {
            const container = document.getElementById('listaMultas');
            const contador = document.getElementById('contadorMultas');
            let multasFiltradas = [...multas];
            const filtroAtleta = document.getElementById('filtroAtleta').value;
            const filtroEstado = document.getElementById('filtroEstado').value;
            if (filtroAtleta) multasFiltradas = multasFiltradas.filter(m => m.atletaId === filtroAtleta);
            if (filtroEstado) multasFiltradas = multasFiltradas.filter(m => filtroEstado === 'paga' ? m.paga : !m.paga);
            multasFiltradas.sort((a, b) => new Date(b.data) - new Date(a.data));
            contador.textContent = multasFiltradas.length;
            if (multasFiltradas.length === 0) {
                container.innerHTML = '<div class="empty-state">Nenhuma multa encontrada.</div>';
                return;
            }
            let html = '';
            multasFiltradas.forEach(multa => {
                const atleta = atletas.find(a => a.id === multa.atletaId);
                const regra = regrasMulta.find(r => r.id === multa.regraId);
                if (!atleta || !regra) return; // Em caso de dados inconsistentes
                html += `
                    <div class="multa-item ${multa.paga ? 'paga' : ''}">
                        <div class="multa-header">
                            <div>
                                <strong>${atleta.nome}${atleta.numero ? ' (#' + atleta.numero + ')' : ''}</strong>
                                <div style="font-size: 0.9rem; color: #6c757d;">${regra.descricao}</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="multa-valor ${multa.paga ? 'pago' : ''}">${Number(regra.valor).toFixed(2)}€</div>
                                <div class="multa-data">${new Date(multa.data).toLocaleDateString('pt-PT')}</div>
                            </div>
                        </div>
                        ${multa.observacoes ? `<div style="font-style: italic; color: #6c757d; margin-top: 5px;">${multa.observacoes}</div>` : ''}
                        <div style="margin-top: 10px;">
                            ${multa.paga ?
                                `<span style=\"color: #28a745; font-weight: bold;\">✓ Paga em ${multa.dataPagamento ? new Date(multa.dataPagamento).toLocaleDateString('pt-PT') : ''}</span>
                                 <button onclick=\"marcarComoPendente('${multa.id}')\" class=\"btn btn-secondary btn-small\">Marcar como Pendente</button>` :
                                `<button onclick=\"marcarComoPaga('${multa.id}')\" class=\"btn btn-small\">Marcar como Paga</button>`}
                            <button onclick="removerMulta('${multa.id}')" class="btn btn-danger btn-small">Remover</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        window.aplicarFiltros = function() { mostrarMultas(); }
        window.limparFiltros = function() { document.getElementById('filtroAtleta').value = ''; document.getElementById('filtroEstado').value = ''; mostrarMultas(); }

        // ====== Debug Helpers (opcionais) ======
        window.debugApp = {
            atletas: () => atletas,
            regras: () => regrasMulta,
            multas: () => multas
        };

        // ====== Arrancar app ======
        window.addEventListener('DOMContentLoaded', inicializar);
    </script>
</body>
</html>
